<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DenyTube ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<style>
  :root{
    --bg:#0b0f12; --card:#0f1720; --accent:#ff3b30; --muted:#9aa7b2; --white:#e6eef3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#07121a 0%, #041018 100%);color:var(--white);min-height:100vh}
  header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));position:sticky;top:0;z-index:90}
  .logo{font-weight:900;color:var(--accent);font-size:20px}
  .search{flex:1;display:flex;gap:8px}
  input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--white)}
  button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--white);cursor:pointer}
  button.primary{background:var(--accent);border-color:transparent;color:#071018}
  main{display:grid;grid-template-columns: 1fr 320px;gap:16px;padding:18px}
  .player{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,10,0.6)}
  .video-wrap{position:relative;padding-top:56.25%;border-radius:8px;overflow:hidden;background:#000}
  iframe{position:absolute;inset:0;border:0;width:100%;height:100%}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .title{font-size:18px;font-weight:700}
  .channel{color:var(--muted);cursor:pointer}
  .actions{display:flex;gap:8px;align-items:center}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,10,0.45)}
  .list{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto;padding-right:6px}
  .list-item{display:flex;gap:8px;align-items:center;cursor:pointer;padding:6px;border-radius:8px}
  .thumb{width:120px;height:68px;object-fit:cover;border-radius:6px;background:#111}
  .vtitle{font-size:13px;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .comments{margin-top:12px}
  .comment{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  .profile{display:flex;gap:10px;align-items:center}
  .avatar{width:48px;height:48px;border-radius:999px;background:linear-gradient(135deg,#334,#556);display:flex;align-items:center;justify-content:center;font-weight:800}
  .small{font-size:13px;color:var(--muted)}
  .stub{color:var(--muted);padding:14px;border-radius:8px;background:rgba(255,255,255,0.01)}
  footer{padding:10px 18px;color:var(--muted);font-size:13px;text-align:center}
  a.link{color:var(--accent);cursor:pointer}
  /* responsive */
  @media(max-width:980px){
    main{grid-template-columns:1fr}
    .sidebar{order:2}
  }
</style>
</head>
<body>

<header>
  <div class="logo">DenyTube</div>
  <div class="search">
    <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ (Enter) ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ; –≤—Å—Ç–∞–≤—å API –∫–ª—é—á –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞" />
    <button id="searchBtn">–ü–æ–∏—Å–∫</button>
    <button id="randomBtn" class="primary">–°–ª—É—á–∞–π–Ω–æ–µ</button>
  </div>
  <div id="userArea" style="display:flex;gap:8px;align-items:center"></div>
</header>

<main>
  <section>
    <div class="player card">
      <div class="video-wrap" id="playerWrap">
        <!-- iframe injected here -->
        <div id="playerStub" class="stub center">–í—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–°–ª—É—á–∞–π–Ω–æ–µ¬ª</div>
      </div>

      <div class="meta">
        <div>
          <div class="title" id="videoTitle">‚Äî</div>
          <div class="channel small" id="videoChannel" onclick="goChannel('')">‚Äî</div>
        </div>
        <div class="actions" id="videoActions">
          <div id="likeBtn" style="display:inline-flex;gap:6px;align-items:center;cursor:pointer">üëç <span id="likeCount">0</span></div>
          <div id="dislikeBtn" style="display:inline-flex;gap:6px;align-items:center;cursor:pointer">üëé <span id="dislikeCount">0</span></div>
          <div id="subscribeBtn" style="display:inline-flex;gap:6px;align-items:center;cursor:pointer">üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</div>
        </div>
      </div>

      <div class="comments card" id="commentsSection">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="font-weight:800">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
          <div class="small" id="commentsCount">0</div>
        </div>
        <div id="commentForm" style="margin-top:8px;display:none">
          <textarea id="commentText" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width:100%;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--white)"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
            <button id="postCommentBtn" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
        <div id="commentsList" style="margin-top:12px"></div>
        <div id="loginHint" class="small" style="margin-top:8px">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
      </div>
    </div>

    <div style="margin-top:16px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
        <div class="small">–¢—Ä–µ–Ω–¥—ã ¬∑ –†–∞–Ω–¥–æ–º</div>
      </div>
      <div id="recommendList" class="list" style="margin-top:10px"></div>
    </div>
  </section>

  <aside class="sidebar">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="small"><a class="link" onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></div>
      </div>
      <div id="profileBox" style="margin-top:10px">
        <div class="stub">–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">–¢—Ä–µ–Ω–¥—ã</div>
        <div class="small"><a class="link" onclick="generateTrending()">–û–±–Ω–æ–≤–∏—Ç—å</a></div>
      </div>
      <div id="trendingList" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div style="font-weight:900">–ö–∞–Ω–∞–ª</div>
      <div class="small" style="margin-top:8px">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (–∞–≤—Ç–æ—Ä = –∫–∞–Ω–∞–ª)</div>
      <div id="channelsList" class="list" style="margin-top:10px"></div>
    </div>
  </aside>
</main>

<footer>
  DenyTube ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –¥–µ–º–æ–≤–µ—Ä—Å–∏—è. –í–∏–¥–µ–æ –≤—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —Å YouTube. –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –≤—Å—Ç–∞–≤—å YouTube API –∫–ª—é—á, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫.
</footer>

<!-- SETTINGS / AUTH MODALS (simple client-side) -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:200">
  <div style="width:980px;max-width:95%;background:#071018;border-radius:12px;padding:18px;color:var(--white);box-shadow:0 20px 60px rgba(0,0,0,0.6)">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900" id="modalTitle">–ú–æ–¥–∞–ª</div>
      <div style="cursor:pointer" onclick="closeModal()">‚úñ</div>
    </div>
    <div id="modalBody" style="margin-top:12px"></div>
  </div>
</div>

<script>
/*
  DenyTube ‚Äî single-file static app.
  Storage structure (localStorage):
    - dt_videos : array of video objects {id,title,channel,channelId,thumb,desc,createdAt}
    - dt_comments : array {id, videoId, author, text, createdAt}
    - dt_users : map username -> {passwordHash, name, avatar, subs:[], likes:{videoId:1/-1}}
    - dt_session : current username
    - dt_settings : {apiKey:...}
  Notes: this is local demo; not secure for real auth.
*/

// ---------- Utilities ----------
const uid = (n=8)=>Math.random().toString(36).slice(2,2+n);
const nowISO = ()=>new Date().toISOString();
const $ = id => document.getElementById(id);
const loadJSON = k => JSON.parse(localStorage.getItem(k) || 'null');
const saveJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const ensure = (k, init) => { if(localStorage.getItem(k)===null) saveJSON(k, init); return loadJSON(k); };

// ---------- Init sample data if empty ----------
function initSampleData(){
  if(!localStorage.getItem('dt_videos')){
    const sample = [
      { id:'dQw4w9WgXcQ', title:'Rick Astley ‚Äî Never Gonna Give You Up', channel:'RickAstley', channelId:'rick', thumb:`https://img.youtube.com/vi/dQw4w9WgXcQ/hqdefault.jpg`, desc:'Classic', createdAt:nowISO() },
      { id:'M7lc1UVf-VE', title:'YouTube Developers Live', channel:'YouTube', channelId:'youtube', thumb:`https://img.youtube.com/vi/M7lc1UVf-VE/hqdefault.jpg`, desc:'YT API demo', createdAt:nowISO() },
      { id:'kXYiU_JCYtU', title:'Linkin Park - Numb', channel:'LinkinPark', channelId:'linkin', thumb:`https://img.youtube.com/vi/kXYiU_JCYtU/hqdefault.jpg`, desc:'Music', createdAt:nowISO() },
      { id:'hY7m5jjJ9mM', title:'Cute Cat Video', channel:'CatChannel', channelId:'cat', thumb:`https://img.youtube.com/vi/hY7m5jjJ9mM/hqdefault.jpg`, desc:'Cats', createdAt:nowISO() },
      { id:'3JZ_D3ELwOQ', title:'Top 10 Algorithms', channel:'CodeAcademy', channelId:'code', thumb:`https://img.youtube.com/vi/3JZ_D3ELwOQ/hqdefault.jpg`, desc:'Programming', createdAt:nowISO() },
      { id:'V-_O7nl0Ii0', title:'Keyboard Cat', channel:'Memes', channelId:'memes', thumb:`https://img.youtube.com/vi/V-_O7nl0Ii0/hqdefault.jpg`, desc:'Meme', createdAt:nowISO() }
    ];
    saveJSON('dt_videos', sample);
  }
  if(!localStorage.getItem('dt_comments')) saveJSON('dt_comments', []);
  if(!localStorage.getItem('dt_users')){
    // create demo user
    const users = { 'demo': { password:'demo', name:'Demo User', avatar:'DU', subs:[], likes:{}, profileDesc:'–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' } };
    saveJSON('dt_users', users);
  }
  if(!localStorage.getItem('dt_settings')) saveJSON('dt_settings', { apiKey: '' });
}
initSampleData();

// ---------- App State ----------
let VIDEOS = ensure('dt_videos', []);
let COMMENTS = ensure('dt_comments', []);
let USERS = ensure('dt_users', {});
let SETTINGS = ensure('dt_settings', { apiKey:'' });

let SESSION = localStorage.getItem('dt_session') || null;
renderUserArea();
renderProfileBox();
renderRecommendList();
renderTrending();
renderChannelsList();

// ---------- Routing helpers ----------
function openVideoById(id){
  const v = VIDEOS.find(x=>x.id===id);
  if(!v) return alert('–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.');
  // inject iframe
  const wrap = $('playerWrap');
  wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${v.id}?autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  $('videoTitle').textContent = v.title;
  $('videoChannel').textContent = v.channel;
  $('videoChannel').onclick = ()=>goChannel(v.channelId);
  // likes/dislikes
  const stats = videoStats(v.id);
  $('likeCount').textContent = stats.likes;
  $('dislikeCount').textContent = stats.dislikes;
  // subscribe button text
  updateSubscribeBtn(v.channelId);
  // comments
  renderComments(v.id);
  // show/hide comment form based on auth
  if(SESSION) {
    $('commentForm').style.display = 'block';
    $('loginHint').style.display = 'none';
  } else {
    $('commentForm').style.display = 'none';
    $('loginHint').style.display = 'block';
  }
  // store last opened
  localStorage.setItem('dt_last_video', v.id);
}

// ---------- Like/Dislike logic (per user) ----------
function videoStats(videoId){
  // count across USERS.likes map
  let likes=0, dislikes=0;
  Object.values(USERS).forEach(u=>{
    const m = u.likes || {};
    if(m[videoId]===1) likes++;
    if(m[videoId]===-1) dislikes++;
  });
  return {likes,dislikes};
}
function toggleLike(videoId, val){
  if(!SESSION) return showAuthModal();
  const user = USERS[SESSION];
  user.likes = user.likes || {};
  const current = user.likes[videoId] || 0;
  if(current === val) user.likes[videoId] = 0;
  else user.likes[videoId] = val;
  USERS[SESSION] = user; saveJSON('dt_users', USERS);
  const stats = videoStats(videoId);
  $('likeCount').textContent = stats.likes;
  $('dislikeCount').textContent = stats.dislikes;
  renderProfileBox();
  renderRecommendList();
}
$('likeBtn').addEventListener('click', ()=> {
  const id = localStorage.getItem('dt_last_video');
  if(id) toggleLike(id, 1);
});
$('dislikeBtn').addEventListener('click', ()=> {
  const id = localStorage.getItem('dt_last_video');
  if(id) toggleLike(id, -1);
});

// ---------- Subscribe (local) ----------
function updateSubscribeBtn(channelId){
  if(!$('subscribeBtn')) return;
  if(!SESSION){ $('subscribeBtn').textContent = 'üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'; return; }
  const user = USERS[SESSION];
  user.subs = user.subs || [];
  const subbed = user.subs.includes(channelId);
  $('subscribeBtn').textContent = subbed ? '‚úî –ü–æ–¥–ø–∏—Å–∞–Ω' : 'üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
}
$('subscribeBtn').addEventListener('click', ()=>{
  const id = localStorage.getItem('dt_last_video');
  if(!id) return;
  const v = VIDEOS.find(x=>x.id===id);
  if(!v) return;
  if(!SESSION) return showAuthModal();
  const user = USERS[SESSION];
  user.subs = user.subs || [];
  const idx = user.subs.indexOf(v.channelId);
  if(idx===-1) user.subs.push(v.channelId); else user.subs.splice(idx,1);
  USERS[SESSION]=user; saveJSON('dt_users',USERS);
  updateSubscribeBtn(v.channelId);
  renderProfileBox();
});

// ---------- Comments ----------
function renderComments(videoId){
  const list = COMMENTS.filter(c=>c.videoId===videoId).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  $('commentsList').innerHTML = list.map(c=>`
    <div class="comment">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="avatar" style="width:36px;height:36px;font-size:13px">${escapeHTML(getInitials(c.author))}</div>
        <div>
          <div style="font-weight:700">${escapeHTML(c.author)}</div>
          <div class="small">${new Date(c.createdAt).toLocaleString()}</div>
        </div>
      </div>
      <div style="margin-top:8px">${escapeHTML(c.text)}</div>
    </div>
  `).join('');
  $('commentsCount').textContent = list.length;
}
function postComment(){
  if(!SESSION) return showAuthModal();
  const text = $('commentText').value.trim();
  if(!text) return;
  const vid = localStorage.getItem('dt_last_video');
  if(!vid) return;
  const c = { id: uid(6), videoId: vid, author: SESSION, text, createdAt: nowISO() };
  COMMENTS.push(c); saveJSON('dt_comments', COMMENTS);
  $('commentText').value = '';
  renderComments(vid);
}
$('postCommentBtn').addEventListener('click', postComment);

// ---------- Search / Recommendations / Trending ----------
function renderRecommendList(){
  // simple: random subset weighted by likes
  const sample = [...VIDEOS];
  sample.sort((a,b)=>{
    const sa = videoStats(a.id).likes;
    const sb = videoStats(b.id).likes;
    return sb - sa || (Math.random()-0.5);
  });
  const top = sample.slice(0,10);
  const container = $('recommendList'); container.innerHTML = '';
  top.forEach(v=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<img class="thumb" src="${v.thumb}"><div style="flex:1"><div class="vtitle">${v.title}</div><div class="small">${v.channel}</div></div>`;
    el.onclick = ()=>openVideoById(v.id);
    container.appendChild(el);
  });
}
function generateTrending(){
  // trending = random shuffle then sort by likes
  const arr = [...VIDEOS];
  arr.sort(()=>Math.random()-0.5);
  arr.sort((a,b)=>videoStats(b.id).likes - videoStats(a.id).likes);
  const container = $('trendingList'); container.innerHTML='';
  arr.slice(0,8).forEach(v=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<img class="thumb" src="${v.thumb}"><div style="flex:1"><div class="vtitle">${v.title}</div><div class="small">${v.channel}</div></div>`;
    el.onclick = ()=>openVideoById(v.id);
    container.appendChild(el);
  });
}
function renderChannelsList(){
  // gather unique channels
  const channels = {};
  VIDEOS.forEach(v=>{ channels[v.channelId] = {id:v.channelId, title:v.channel, count:(channels[v.channelId]?.count||0)+1} });
  const container = $('channelsList'); container.innerHTML='';
  Object.values(channels).forEach(ch=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div style="flex:1"><div class="vtitle">${ch.title}</div><div class="small">${ch.count} –≤–∏–¥–µ–æ</div></div>`;
    el.onclick = ()=>goChannel(ch.id);
    container.appendChild(el);
  });
}

// ---------- Channels, Profiles ----------
function goChannel(channelId){
  // show modal with channel videos
  const chVideos = VIDEOS.filter(v=>v.channelId===channelId);
  showModal(`–ö–∞–Ω–∞–ª ‚Äî ${channelId}`, `
    <div style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto">
      ${chVideos.map(v=>`<div style="display:flex;gap:8px;align-items:center;cursor:pointer;padding:8px;border-radius:8px" onclick="openVideoFromModal('${v.id}')">
        <img style="width:160px;height:90px;object-fit:cover;border-radius:6px" src="${v.thumb}">
        <div><div style="font-weight:700">${escapeHTML(v.title)}</div><div class="small">${escapeHTML(v.channel)}</div></div>
      </div>`).join('')}
    </div>
  `);
}
function openVideoFromModal(id){ closeModal(); openVideoById(id); }

function renderProfileBox(){
  const container = $('profileBox');
  if(!SESSION){ container.innerHTML = `<div class="stub">–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. <a class="link" onclick="showAuthModal()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>`; return; }
  const user = USERS[SESSION];
  const html = `
    <div class="profile">
      <div class="avatar">${escapeHTML(getInitials(user.name || SESSION))}</div>
      <div>
        <div style="font-weight:800">${escapeHTML(user.name || SESSION)}</div>
        <div class="small">${escapeHTML(user.profileDesc||'')} </div>
        <div style="margin-top:8px" class="small">–ü–æ–¥–ø–∏—Å–æ–∫: ${ (user.subs||[]).length } ¬∑ –õ–∞–π–∫–æ–≤: ${countUserLikes(SESSION)}</div>
        <div style="margin-top:8px"><button onclick="showProfile('${SESSION}')">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>
      </div>
    </div>
  `;
  container.innerHTML = html;
}
function showProfile(username){
  const u = USERS[username];
  if(!u) return alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
  showModal(`–ü—Ä–æ—Ñ–∏–ª—å ‚Äî ${escapeHTML(username)}`, `
    <div style="display:flex;gap:12px;align-items:center">
      <div class="avatar" style="width:72px;height:72px;font-size:22px">${escapeHTML(getInitials(u.name||username))}</div>
      <div>
        <div style="font-weight:900">${escapeHTML(u.name||username)}</div>
        <div class="small">${escapeHTML(u.profileDesc||'')}</div>
        <div style="margin-top:8px" class="small">–ü–æ–¥–ø–∏—Å–æ–∫: ${(u.subs||[]).length} ¬∑ –õ–∞–π–∫–æ–≤: ${countUserLikes(username)}</div>
      </div>
    </div>
    <hr style="margin:12px 0">
    <div><b>–ü–æ–¥–ø–∏—Å–∫–∏</b></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">${(u.subs||[]).map(s=>`<div class="stub" style="padding:6px 10px;cursor:pointer" onclick="goChannel('${s}')">${escapeHTML(s)}</div>`).join('')}</div>
    <hr style="margin:12px 0">
    <div><b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ)</b></div>
    <div style="margin-top:8px;max-height:220px;overflow:auto">
      ${COMMENTS.filter(c=>c.author===username).map(c=>`<div class="comment"><div style="font-weight:700">${escapeHTML(c.text)}</div><div class="small">${new Date(c.createdAt).toLocaleString()}</div></div>`).join('')}
    </div>
  `);
}

// ---------- Auth (client-side) ----------
function showAuthModal(){
  showModal('–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', `
    <div style="display:flex;gap:8px;align-items:center">
      <input id="authUser" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--white)">
      <input id="authName" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--white)">
      <input id="authPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--white)">
      <button class="primary" onclick="authRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button onclick="authLogin()">–í–æ–π—Ç–∏</button>
    </div>
    <div class="small" style="margin-top:8px">–≠—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</div>
  `);
}
function authRegister(){
  const user = $('authUser').value.trim();
  const pass = $('authPass').value;
  const name = $('authName').value.trim() || user;
  if(!user || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
  if(USERS[user]) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
  USERS[user] = { password: pass, name, avatar: getInitials(name), subs: [], likes: {}, profileDesc:'' };
  saveJSON('dt_users', USERS);
  localStorage.setItem('dt_session', user);
  SESSION = user;
  closeModal();
  renderUserArea();
  renderProfileBox();
  alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤–æ—à–ª–∏ –∫–∞–∫ ' + user);
}
function authLogin(){
  const user = $('authUser').value.trim();
  const pass = $('authPass').value;
  if(!user || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
  if(!USERS[user] || USERS[user].password !== pass) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
  localStorage.setItem('dt_session', user);
  SESSION = user;
  closeModal();
  renderUserArea();
  renderProfileBox();
  alert('–í–æ—à–ª–∏ –∫–∞–∫ ' + user);
}
function logout(){
  localStorage.removeItem('dt_session');
  SESSION = null;
  renderUserArea();
  renderProfileBox();
}
function renderUserArea(){
  const area = $('userArea'); area.innerHTML = '';
  if(SESSION){
    const u = USERS[SESSION];
    area.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="small">${escapeHTML(u.name||SESSION)}</div><button onclick="showProfile('${SESSION}')">–ü—Ä–æ—Ñ–∏–ª—å</button><button onclick="logout()">–í—ã–π—Ç–∏</button></div>`;
  } else {
    area.innerHTML = `<div style="display:flex;gap:8px"><button onclick="showAuthModal()">–í–æ–π—Ç–∏</button><button onclick="showAuthModal()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>`;
  }
}

// ---------- Settings (API key) ----------
function openSettings(){
  showModal('–ù–∞—Å—Ç—Ä–æ–π–∫–∏', `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="small">–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ YouTube, –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π YouTube Data API v3 –∫–ª—é—á. –ë–µ–∑ –∫–ª—é—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –≤–∏–¥–µ–æ.</div>
      <input id="apiKeyInput" placeholder="API KEY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--white)" value="${escapeHTML(SETTINGS.apiKey||'')}">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  `);
}
function saveSettings(){
  const k = $('apiKeyInput').value.trim();
  SETTINGS.apiKey = k;
  saveJSON('dt_settings', SETTINGS);
  SETTINGS = ensure('dt_settings', {});
  closeModal();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

// ---------- Modal helpers ----------
function showModal(title, html){
  $('modalTitle').textContent = title;
  $('modalBody').innerHTML = html;
  $('modal').style.display = 'flex';
}
function closeModal(){ $('modal').style.display = 'none'; $('modalBody').innerHTML = ''; }

// ---------- Small helpers ----------
function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function getInitials(str=''){ return String(str||'U').split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase(); }
function countUserLikes(username){ const u = USERS[username]; if(!u) return 0; return Object.values(u.likes||{}).filter(x=>x===1).length; }

// ---------- Simple Search (local or via API if key present) ----------
async function performSearch(q){
  q = (q||'').trim();
  if(!q) return;
  if(SETTINGS.apiKey){
    // try YouTube Data API (client-side request) - NOTE: exposing key publicly in GitHub is your risk
    try{
      const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${encodeURIComponent(SETTINGS.apiKey)}&q=${encodeURIComponent(q)}&part=snippet&type=video&maxResults=24`);
      const json = await res.json();
      if(json.items){
        // convert to local video objects (but do not save to storage)
        const items = json.items.map(i=>({
          id: i.id.videoId,
          title: i.snippet.title,
          channel: i.snippet.channelTitle,
          channelId: i.snippet.channelId,
          thumb: i.snippet.thumbnails?.high?.url || i.snippet.thumbnails?.default?.url,
          desc: i.snippet.description
        }));
        showSearchResults(items);
        return;
      }
    }catch(e){
      console.warn('API search failed', e);
      alert('–ü–æ–∏—Å–∫ –ø–æ API –Ω–µ —É–¥–∞–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫.');
    }
  }
  // local search fallback
  const qlow = q.toLowerCase();
  const items = VIDEOS.filter(v=> (v.title+v.channel+v.desc).toLowerCase().includes(qlow));
  showSearchResults(items);
}
function showSearchResults(items){
  // reuse recommendList area for results
  const container = $('recommendList'); container.innerHTML = '';
  if(items.length===0){ container.innerHTML = '<div class="stub">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  items.forEach(v=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<img class="thumb" src="${v.thumb}"><div style="flex:1"><div class="vtitle">${v.title}</div><div class="small">${v.channel}</div></div>`;
    el.onclick = ()=>openVideoById(v.id);
    container.appendChild(el);
  });
  // scroll to player
  window.scrollTo({ top:0, behavior:'smooth' });
}

// ---------- Helpers to add videos locally ----------
function addLocalVideo(obj){
  // obj: {id,title,channel,channelId,thumb,desc}
  if(!obj || !obj.id) return;
  if(VIDEOS.some(v=>v.id===obj.id)) return;
  VIDEOS.push(obj);
  saveJSON('dt_videos', VIDEOS);
  renderChannelsList();
  renderRecommendList();
  generateTrending();
}

// ---------- Trending generator / auto update simulation ----------
function simulateAutoUpdate(){
  // every time called, randomly add a "new" video occasionally
  if(Math.random() < 0.12){
    const id = uid(10);
    const v = { id, title: `–ù–æ–≤–æ–µ –≤–∏–¥–µ–æ ${id.slice(0,6)}`, channel:`User${id.slice(0,4)}`, channelId:`ch_${id.slice(0,6)}`, thumb:`https://picsum.photos/seed/${id}/320/180`, desc:'–ê–≤—Ç–æ—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ', createdAt: nowISO() };
    addLocalVideo(v);
    console.log('Added auto video', v.id);
  }
}
setInterval(()=>{
  simulateAutoUpdate();
  renderRecommendList();
  generateTrending();
}, 60*1000); // every minute (simulates –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –≤–∏–¥–µ–æ)

// ---------- Small utilities for modal actions from strings ----------
window.openVideoFromModal = openVideoFromModal;

// ---------- Events ----------
$('searchBtn').addEventListener('click', ()=>performSearch($('searchInput').value));
$('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') performSearch(e.target.value); });
$('randomBtn').addEventListener('click', ()=> {
  // pick a random video from VIDEOS
  const id = VIDEOS[Math.floor(Math.random()*VIDEOS.length)].id;
  openVideoById(id);
});

// ---------- Escape hatch: load last opened video if exists ----------
const last = localStorage.getItem('dt_last_video');
if(last) setTimeout(()=>openVideoById(last), 400);

// ---------- helper escape for names shown in HTML attributes -->
function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

</script>
</body>
</html>
